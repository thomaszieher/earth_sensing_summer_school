---
title: "Remote LWF-Brook90 run"
author: "Thomas Zieher"
date: "2025-06-04"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r header,include=T}
#####################################################
##                                                 ##
##      ######      #########  ##          ##      ##
##      #######     ########   ##          ##      ##
##      ##    ##    ##         ##          ##      ##
##      ##   ##     ##         ##          ##      ##
##      ######      ######     ##          ##      ##
##      #######     #####      ##          ##      ##
##      ##    ##    ##         ##    ##    ##      ##
##      ##     ##   ##         ##   ####   ##      ##
##      ##     ##   ##         ##  ##  ##  ##      ##
##      ########    ##          ####    ####       ##
##      #######     ##           ##      ##        ##
##                                                 ##
#####################################################
##                                                 ##
##  Author: Thomas Zieher                          ##
##  Institute: Nat Haz, 6.3                        ##
##  Date: 2025-05-28                               ##
##  License: GNU GPL V.3 or later                  ##
##                                                 ##
#####################################################
##  Description: Run LWF-Brook90 at San Vito di Cadore
##  Environment: renv
#####################################################

##set include=F to omit header in output
##code partly taken and modified after Schmidt-Walter et al. (2020), Supplement

```


```{r setup,include=FALSE}
knitr::opts_chunk$set(echo=T)

##empty environment
rm(list=ls())

##install package renv
#install.packages("renv")

##install packages with respective version
renv::snapshot()
renv::restore()


library(LWFBrook90R)
library(data.table)
library(xts)
library(dygraphs)
library(ggplot2)
library(climatol)
library(aqp)
library(rstudioapi)


##retrieving script path
proj_path=dirname(rstudioapi::getActiveProject())

##set paths
root=paste(proj_path,"earth_sensing_summer_school",sep="/")
model_path=paste(root,"data/lwf_brook90",sep="/")
meteo_path=paste(root,"data/era5",sep="/")
soil_path=paste(root,"data/soilgrids",sep="/")

##set period
start_date=as.Date("2019-01-01")
end_date=as.Date("2024-12-31")

##select pid
pid="P1"#"P2"#"P3"#"P4"#


##plot soil profile
soilplot=function(soil,hum_depth=0.0,plots=T){

  maxdepth=min(soil$lower)*-100
  
  ##start empty plot
  plot(NA,NA,xlim=c(0,1),ylim=c(maxdepth,hum_depth*100),
       xlab="",ylab="",las=1,axes=F)
  
  ##prepare axes
  axis(side=2,las=1,at=seq(0,maxdepth,10),mgp=c(0,0.8,0),tck=-0.025)
  mtext(side=2,"Depth [cm]",line=2.5)
  
  mtext(side=3,"Soil texture fractions [%]",line=2.5)
  axis(side=3,at=seq(0,1,length.out=5),labels=seq(0,100,length.out=5))

  ##go through horizons
  #line=2
  for (line in 1:nrow(soil)){
    
    if (soil$hor_num[line]==0){
      polygon(x=c(0,1,1,0),
        y=c(-soil$upper[line]*100,-soil$upper[line]*100,-soil$lower[line]*100,-soil$lower[line]*100),
        col="#00bb0050"
      )
    }
    
    ##add skelettgehalt
    polygon(x=c(0,(0+(soil$gravel[line])),(0+(soil$gravel[line])),0),
            y=c(-soil$upper[line]*100,-soil$upper[line]*100,-soil$lower[line]*100,-soil$lower[line]*100),
            col="#11111150"
    )
    
    ##plot texture content
    start_texture=(soil$gravel[line])
    texture=soil[line,c("sand","silt","clay","gravel")]
    texture$sand_scaled=texture$sand*(1-texture$gravel)
    texture$silt_scaled=texture$silt*(1-texture$gravel)
    texture$clay_scaled=texture$clay*(1-texture$gravel)

    polygon(x=c(start_texture,
                start_texture+(texture$sand_scaled/100.0),
                start_texture+(texture$sand_scaled/100.0),
                start_texture),
            y=c(-soil$upper[line]*100,-soil$upper[line]*100,-soil$lower[line]*100,-soil$lower[line]*100),
            col="#ff000030"
    )
    polygon(x=c(start_texture+(texture$sand_scaled/100.0),
                start_texture+(texture$sand_scaled/100.0)+(texture$silt_scaled/100.0),
                start_texture+(texture$sand_scaled/100.0)+(texture$silt_scaled/100.0),
                start_texture+(texture$sand_scaled/100.0)),
            y=c(-soil$upper[line]*100,-soil$upper[line]*100,-soil$lower[line]*100,-soil$lower[line]*100),
            col="#ffaa0030"
    )
    polygon(x=c(start_texture+(texture$sand_scaled/100.0)+(texture$silt_scaled/100.0),
                start_texture+(texture$sand_scaled/100.0)+(texture$silt_scaled/100.0)+(texture$clay_scaled/100.0),
                start_texture+(texture$sand_scaled/100.0)+(texture$silt_scaled/100.0)+(texture$clay_scaled/100.0),
                start_texture+(texture$sand_scaled/100.0)+(texture$silt_scaled/100.0)),
            y=c(-soil$upper[line]*100,-soil$upper[line]*100,-soil$lower[line]*100,-soil$lower[line]*100),
            col="#ffff0030"
    )

  }
}




# ##calculate centroid of soil texture class after P. Bourke 1988, https://lexrent.eu/wp-content/uploads/torza/artikel_groep_sub_2_docs/BYZ_3_Polygon-Area-and-Centroid.pdf
# ##additionally: translate class centroid to another classification
# get_centroid=function(original="AT.TT",target="AT.TT",class){
#   ##partly adapted from https://github.com/cran/soiltexture/blob/master/R/soiltexture.R
#   
#   ##original system
#   TT.data_prev=TT.get(original)
#   poly.nm=names(TT.data_prev$"tt.polygons")
#   xy.prev=TT.css2xy( 
#     tri.data=TT.data_prev$tt.points*100, 
#     geo=TT.geo.get(class.sys=original)
#   )
#   
#   ##target system
#   TT.data_target=TT.get(target)
#   poly.nm=names(TT.data_target$"tt.polygons")
#   xy.target=TT.css2xy( 
#     tri.data=TT.data_target$tt.points*100, 
#     geo=TT.geo.get(class.sys=target)
#   )
#   
#   ##compute original xy position of class
#   sel.vec_prev=(TT.data_prev$"tt.polygons"[[ class ]])$"points"
#   cent_xy_prev=TT.polygon.centroids(
#     pol.x=xy.prev[sel.vec_prev,"xpos"], 
#     pol.y=xy.prev[sel.vec_prev,"ypos"] 
#   )
#   
#   ##re-format for TT.xy2css
#   xypos_prev=data.frame(t(cent_xy_prev))
#   names(xypos_prev)=c("xpos","ypos")
#   
#   ##calculate centroids in terms of sand, silt and clay fraction
#   center_prev=TT.xy2css(xy.data=xypos_prev,
#                         geo=TT.geo.get(class.sys=original)
#   )
#   
#   ##get target class
#   class_target=TT.points.in.classes(center_prev,class.sys=target,PiC.type="t")
#   
#   ##compute centroid of target class
#   sel.vec_target=(TT.data_target$"tt.polygons"[[ class_target ]])$"points"
#   cent_xy_target=TT.polygon.centroids(
#     pol.x=xy.target[sel.vec_target,"xpos"], 
#     pol.y=xy.target[sel.vec_target,"ypos"] 
#   )
#   
#   ##re-format for TT.xy2css
#   xypos_target=data.frame(t(cent_xy_target))
#   names(xypos_target)=c("xpos","ypos")
#   
#   ##calculate centroids in terms of sand, silt and clay fraction
#   center_target=TT.xy2css(xy.data=xypos_target,
#                           geo=TT.geo.get(class.sys=target)
#   )
#   
#   ##return sand, silt and clay of centroid in target system
#   return(center_target)
# }

```


***
### Read meteo data

```{r meteo,echo=T,message=F,warning=F,error=F}

##read ERA5 meteo data
meteo_daily=data.table(read.table(paste(meteo_path,"ERA5_meteo_daily.csv",sep="/"),header=T,sep=";",stringsAsFactors=F))
meteo_daily$dates=as.Date(meteo_daily$dates)

##adjust meteo
meteo_daily$prec=meteo_daily$prec*0.5
meteo_daily$tmean=meteo_daily$tmean+5.0
meteo_daily$tmin=meteo_daily$tmin+5.0
meteo_daily$tmax=meteo_daily$tmax+5.0


##Walther-Lieth diagram
##aggregate to monthly values
tmin=setDT(meteo_daily)[year(dates)%in%year(start_date):year(end_date), .(tmin=min(tmin)),by=.(yr=year(dates),mon=month(dates))]
tmax=setDT(meteo_daily)[year(dates)%in%year(start_date):year(end_date), .(tmax=max(tmax)),by=.(yr=year(dates),mon=month(dates))]
psum=setDT(meteo_daily)[year(dates)%in%year(start_date):year(end_date), .(psum=sum(prec)),by=.(yr=year(dates),mon=month(dates))]

##aggregate to mean monthly values
meteo_monthly=aggregate(data.frame(psum=psum$psum,
                                   tmax=tmax$tmax,
                                   tmin=tmin$tmin,
                                   tabsmin=abs(tmin$tmin)),
                        by=list(tmin$mon),FUN="mean")

par(mfrow=c(1,1))
diagwl(t(meteo_monthly[,2:5]), est="Location",alt="XXX",mlab="en",cols=NULL)


# hist(meteo_daily$prec)
# plot(meteo_daily$prec,type="h")
# aggregate(psum$psum,by=list(psum$yr),FUN="sum")
##too much precipitation, too cold
##grid point at high elevation??

```


***
### Parameterization
General options

```{r options,echo=T,message=F,warning=F,error=F}

##model options
options_forest=set_optionsLWFB90(startdate=start_date,
                                 enddate=end_date,
                                 budburst_method="Menzel",
                                 leaffall_method="vonWilpert",
                                 root_method="betamodel",
                                 lai_method="b90")

```


Soil profile

```{r soil,echo=T,message=F,warning=F,error=F}


##import soil data
soilgrid_profiles=readRDS(paste(soil_path,"soilgrids_profiles.rds",sep="/"))
sites=aqp::site(soilgrid_profiles)
profiles=aqp::horizons(soilgrid_profiles)

##get single location
location=sites[sites$id==pid,]


# ##take soilgrids profile
# soil=profiles[profiles$id==pid,]
# 
# ##modifications for LWF-Brook90
# soil["upper"]=soil$upr/100.0*-1.0
# soil["lower"]=soil$lwr/100.0*-1.0
# soil["hor_num"]=1:nrow(soil)
# 
# soilplot(soil)



##get single location
location=sites[sites$id==pid,]

##or use individual soil parameterization
soil_raw=data.table(upper=c(0,-0.08,-0.13,-0.48),
                    lower=c(-0.08,-0.13,-0.48,-0.73))
soil_raw$hor_num=1:nrow(soil_raw)
soil_raw$horizon=c("FH","Ah","Bv","Cv")
soil_raw$gravel=c(0,0.3,0.6,0.95)

##add numeric values (mean) of soil bulk density estimated in the field
#"Class 1: very low (0.9-1.2 kg/dm3)"
#"Class 2: low (1.2-1.4 kg/dm3)"
#"Class 3: intermediate (1.4-1.6 kg/dm3)"
#"Class 4: dense (1.6-1.8 kg/dm3)"
#"Class 5: very dense (1.8-1.9 kg/dm3)"
soil_raw$bd=c(0,1.5,1.7,1.7)

##add estimation of soil organic carbon
soil_raw$corg=c(0,5,2,0)

##only for PTF after Woesten et al. 1999
soil_raw$topsoil=c(1,1,0,0)

##add sand, silt and sand content of the texture classes (required for PTF after Woesten et al. 1999)
soil_raw$sand=c(0,7.190476,19,19)
soil_raw$silt=c(0,72.19048,57.5,57.5)
soil_raw$clay=c(0,20.61905,23.5,23.5)

##add soil hydraulic parameters for humus layer using the PTF after Hammel and Kennel 2001
hydpars=data.table(LWFBrook90R::hydpar_ff_b90())

##add soil hydraulic parameters for mineral soil using the PTF after Woesten et al. 1999 (continuous)
# hydpars=rbind(hydpars,data.table(LWFBrook90R::hydpar_hypres(clay=soil_loc$clay,
#                                                               silt=soil_loc$silt,
#                                                               bd=soil_loc$bd,
#                                                               oc.pct=soil_loc$corg,
#                                                               topsoil=soil_loc$topsoil)))

##use PTF after Wessolek 2009
hydpars=rbind(hydpars,hydpar_wessolek_tab(texture="Ut4"))
hydpars=rbind(hydpars,hydpar_wessolek_tab(texture="Lu"))
hydpars=rbind(hydpars,hydpar_wessolek_tab(texture="Lu"))

soil=cbind(soil_raw,hydpars)

soilplot(soil,hum_depth=soil$lower[1])


```


Vegetation parameters

```{r vegetation,echo=T,message=F,warning=F,error=F}

##load parameterizations for oak (Quercus robur) and pine (Pinus sylvestris) from other project
load(paste(model_path,"veg_param.rda",sep="/"))

##individual vegetation parameterization
##taken from Schmidt-Walter et al. (2020), Supplement
params_pine=set_paramLWFB90(budburst_species="Picea abies (frueh)",
                              maxlai=6,
                              winlaifrac=0.8,
                              height=25,
                              sai=0.035*25,
                              glmax=0.0053,
                              radex=0.5,
                              alb=0.14,
                              albsn=0.14,
                              maxrlen=3100,
                              betaroot=0.976,
                              maxrootdepth=-1.2,
                              lwidth=0.004,
                              frintlai=0.12,
                              frintsai=0.14,
                              cintrl=0.2,
                              cintrs=0.4
                              )

params_oak=set_paramLWFB90(budburst_species="Fagus sylvatica",
                             maxlai=6,
                             winlaifrac=0,
                             height=25,
                             sai=0.035*25,
                             glmax=0.0053,
                             radex=0.6,
                             alb=0.18,
                             albsn=0.23,
                             maxrlen=3500,
                             betaroot=0.966,
                             maxrootdepth=-1.4,
                             lwidth=0.05,
                             frintlai=0.12,
                             frintsai=0.25,
                             cintrl=0.2,
                             cintrs=0.4
                             )

```


Site specifics

```{r site,echo=T,warning=F,error=F}

##specify local characteristics
rooting_depth=-0.5 #m
drain=1 ##Switch for lower boundary condition to be free drainage (1) or no flow (0)
ilayer=4 ##Number of layers from top to which infiltration is distributed
infexp=0.6 ##Shape parameter for distribution of infiltration, for value 0 infiltration is in top layer only.

##set location's coordinates
params_pine$coords_x=location$lon
params_pine$coords_y=location$lat
params_oak$coords_x=location$lon
params_oak$coords_y=location$lat

##set location's aspect and slope angle
params_pine$aspect=location$aspect
params_pine$dslope=location$slope
params_pine$eslope=location$slope
params_oak$aspect=location$aspect
params_oak$dslope=location$slope
params_oak$eslope=location$slope
  
##set location's rooting depth
params_pine$maxrootdepth=rooting_depth
params_oak$maxrootdepth=rooting_depth

##set location's drainage parameter
params_pine$drain=drain
params_oak$drain=drain

##set location's ilayer parameter
params_pine$ilayer=ilayer
params_oak$ilayer=ilayer

##set location's infexp parameter
params_pine$infexp=infexp
params_oak$infexp=infexp


```



***
### Run model

```{r model,echo=F,warning=F,error=F}

res_pine=run_LWFB90(options_b90=options_forest,
                    param_b90=params_pine,
                    climate=meteo_daily,
                    soil=soil
                    )

res_oak=run_LWFB90(options_b90=options_forest,
                   param_b90=params_oak,
                   climate=meteo_daily,
                   soil=soil
                   )

```


***
### Plots
Daily water balance components

```{r wb_daily,echo=F,message=F,warning=F,error=F}

##bind evap-fluxes from result lists
wb_pine=rbindlist(list(`pine`=res_pine$output),
                       idcol="vegetation")

wb_oak=rbindlist(list(`oak`=res_oak$output),
                      idcol="vegetation")

##add date
wb_pine$date=as.Date(sprintf("%i-%0.2i-%0.2i",wb_pine$yr,wb_pine$mo,wb_pine$da),format="%Y-%m-%d")
wb_oak$date=as.Date(sprintf("%i-%0.2i-%0.2i",wb_oak$yr,wb_oak$mo,wb_oak$da),format="%Y-%m-%d")

##add surface runoff
wb_pine[,surfrunoff := flow-vrfln]
wb_oak[,surfrunoff := flow-vrfln]

##bind results
wb=rbind(wb_pine,wb_oak)

##rfal and smlt from model results
tmin=xts(meteo_daily$tmin,order.by=meteo_daily$dates)
tmax=xts(meteo_daily$tmax,order.by=meteo_daily$dates)
tmean=xts(meteo_daily$tmean,order.by=meteo_daily$dates)

nprec=xts(wb_oak$rfal,order.by=wb_oak$date)
sfal=xts(wb_oak$sfal,order.by=wb_oak$date)
smlt=xts(-wb_oak$smlt,order.by=wb_oak$date)
srf=xts(-wb_oak$surfrunoff,order.by=wb_oak$date)

tseries_plot=merge(tmin,tmax,tmean,nprec,sfal,smlt,srf)

##fill missing 15min measurements with closest measurement
#tseries_smc_filled=na.locf(tseries_plot,fromLast=F,maxgap=10)

##plot wb
cols_prec=c("#0800ff","#50aaff","#50ffff","#F39200","#ebeb34","#F39200","#FF1000")
par(mar=c(5,5,5,5))
dygraph(tseries_plot,width=600,height=400) %>%
  dyAxis("y",label="Water balance elements [mm]",valueRange=c(-20,60)) %>%
  dyAxis("y2",label="Temperature [deg C]",valueRange=c(-10,30)) %>%
  dyBarSeries('nprec',label="Rainfall [mm/d]",axis="y") %>% 
  dyBarSeries('sfal',label="Snow fall [mm/d]",axis="y") %>% 
  dyBarSeries('smlt',label="Snow melt [mm/d]",axis="y") %>% 
  dyBarSeries('srf',label="Surface runoff [mm/d]",axis="y") %>% 
  dyOptions(stackedGraph=T) %>%
  dySeries('tmin',label="Tmin [deg C]",axis="y2") %>% 
  dySeries('tmean',label="Tmean [deg C]",axis="y2") %>% 
  dySeries('tmax',label="Tmax [deg C]",axis="y2") %>% 
  dyOptions(stackedGraph=F,colors=cols_prec) %>%
  dyRangeSelector(height=20) %>%
  dyLegend(show="always",width=120)


```


***
### Calculate indices

```{r indices,echo=F,warning=F,error=F}

##re-read outputs
output_oak=wb_oak
output_pine=wb_pine

##indices oak
output_oak$tratio=output_oak$tran/output_oak$ptran
output_oak$tratio[output_oak$tratio>1]=1
output_oak$tratio[is.nan(output_oak$tratio)]=1
output_oak$tratio[is.infinite(output_oak$tratio)]=1
output_oak$tdef=output_oak$ptran-output_oak$tran
output_oak$tdef[output_oak$tdef<0]=0

##indices pine
output_pine$tratio=output_pine$tran/output_pine$ptran
output_pine$tratio[output_pine$tratio>1]=1
output_pine$tratio[is.nan(output_pine$tratio)]=1
output_pine$tratio[is.infinite(output_pine$tratio)]=1
output_pine$tdef=output_pine$ptran-output_pine$tran
output_pine$tdef[output_pine$tdef<0]=0

##calc indices for mixed forest
mixed=data.frame(doy=output_oak$doy,
                 yr=output_oak$yr,
                 date=output_oak$date,
                 rnet=apply(cbind(output_oak$rnet,output_pine$rnet),1,FUN="mean",na.rm=T),
                 smlt=apply(cbind(output_oak$smlt,output_pine$smlt),1,FUN="mean",na.rm=T),
                 relawat=apply(cbind(output_oak$relawat,output_pine$relawat),1,FUN="mean",na.rm=T),
                 tdef=apply(cbind(output_oak$tdef,output_pine$tdef),1,FUN="mean",na.rm=T),
                 tratio=apply(cbind(output_oak$tratio,output_pine$tratio),1,FUN="mean",na.rm=T)
)


##define colors
col_oak="#ff916e"
col_pine="#159837"
col_mixed="#a387ff"
cols_treesp=c(col_oak,col_pine,col_mixed)

##prec and snow melt
prec=xts(mixed$rnet[mixed$yr%in%unique(output_oak$yr)],order.by=mixed$date[mixed$yr%in%unique(output_oak$yr)])
smlt=xts(mixed$smlt[mixed$yr%in%unique(output_oak$yr)],order.by=mixed$date[mixed$yr%in%unique(output_oak$yr)])

```


***
### Check soil water storage in individual soil layers

```{r swati,echo=F,warning=F,error=F}

##bind evap-fluxes from result lists
swat_pine=rbindlist(list(`pine`=res_pine$layer_output),
                    idcol="vegetation")

swat_oak=rbindlist(list(`oak`=res_oak$layer_output),
                   idcol="vegetation")


##add dates to outputs
swat_pine[,dates:=as.POSIXct(paste(yr,mo,da,sep="-"),tz="UTC")]
swat_oak[,dates:=as.POSIXct(paste(yr,mo,da,sep="-"),tz="UTC")]

##get theta at topmost soil layer
swat_pine_nl=swat_pine[which(nl==2),list(theta=mean(theta)),by=dates]
swat_oak_nl=swat_oak[which(nl==2),list(theta=mean(theta)),by=dates]

##compare
ts_swat_pine_nl=xts(swat_pine_nl$theta*100,order.by=swat_pine_nl$dates)
ts_swat_oak_nl=xts(swat_oak_nl$theta*100,order.by=swat_oak_nl$dates)
tseries_plot_nl=merge(prec,smlt,ts_swat_oak_nl,ts_swat_pine_nl)

##fill missing 15min measurements with closest measurement
#tseries_smc_filled=na.locf(tseries_plot,fromLast=F,maxgap=10)

##plot
cols_prec=c("#F39200","#86E29E","#0800ff","#50ffff")
par(mar=c(5,5,5,5))
dygraph(tseries_plot_nl,width="auto",height=400) %>%
  dyAxis("y",label="Soil moisture content [%]",valueRange=c(20,60)) %>%
  dyAxis("y2",label="Precipitation [mm/d]",valueRange=c(50,0)) %>%
  dyBarSeries('prec',label="Rainfall [mm/d]",axis="y2") %>%  
  dyBarSeries('smlt',label="Snow melt [mm/d]",axis="y2") %>% 
  dyOptions(stackedGraph=T,colors=cols_prec) %>%
  dySeries('ts_swat_oak_nl',label="SMC oak nl [%]",axis="y") %>%
  dySeries('ts_swat_pine_nl',label="SMC pine nl [%]",axis="y") %>%
  dyRangeSelector(height=20) %>%
  dyOptions(stackedGraph=F,colors=cols_prec) %>%
  dyLegend()

```


***
### Relative extractable water (REW) per DOY
Values <Q01 are shown as point markers

```{r rew_plot,echo=F,warning=F,error=F,out.width="80%",fig.width=10,fig.height=13}

##plot all years
par(mfrow=c(6,1),mar=c(2,4,3,1),pty="m")
#year_plot=unique(output_oak$yr)[1]
for (year_plot in unique(output_oak$yr)){
  oak_sub=output_oak[output_oak$yr==year_plot,]
  pine_sub=output_pine[output_pine$yr==year_plot,]
  mixed_sub=mixed[mixed$yr==year_plot,]
  
  plot(NA,NA,xlim=c(1,366),ylim=c(0,2),xlab="",ylab="Relative extractable water",main=sprintf("Relative extractable water %i",year_plot))
  lines(oak_sub$doy,oak_sub$relawat,col=col_oak)
  lines(pine_sub$doy,pine_sub$relawat,col=col_pine)
  lines(mixed_sub$doy,mixed_sub$relawat,col=col_mixed)

  points(oak_sub$doy[oak_sub$relawat<quantile(na.omit(oak_sub$relawat),0.01)],
         oak_sub$relawat[oak_sub$relawat<quantile(na.omit(oak_sub$relawat),0.01)],col=col_oak,pch=1)
  points(pine_sub$doy[pine_sub$relawat<quantile(na.omit(pine_sub$relawat),0.01)],
         pine_sub$relawat[pine_sub$relawat<quantile(na.omit(pine_sub$relawat),0.01)],col=col_pine,pch=3)
  points(mixed_sub$doy[mixed_sub$relawat<quantile(na.omit(mixed_sub$relawat),0.01)],
         mixed_sub$relawat[mixed_sub$relawat<quantile(na.omit(mixed_sub$relawat),0.01)],col=col_mixed,pch=5)
  
  ##plot thresholds
  abline(h=0.2,col="red",lty=2)
  abline(h=0.4,col="orange",lty=2)
  abline(h=1,col="green",lty=2)
  
  legend("topright",legend=c("Oak","Pine","Mixed"),lwd=2,pch=c(1,3,5),col=cols_treesp)
  
}


##dygraph
cols=c("#0800ff","#44bbff",cols_treesp)
##rfal and smlt from model results
Oak=xts(output_oak$relawat[output_oak$yr%in%unique(output_oak$yr)],order.by=output_oak$date[output_oak$yr%in%unique(output_oak$yr)])
Pine=xts(output_pine$relawat[output_pine$yr%in%unique(output_oak$yr)],order.by=output_pine$date[output_pine$yr%in%unique(output_oak$yr)])
Mixed=xts(mixed$relawat[mixed$yr%in%unique(output_oak$yr)],order.by=mixed$date[mixed$yr%in%unique(output_oak$yr)])

tseries_plot=merge(prec,smlt,Oak,Pine,Mixed)

##fill missing 15min measurements with closest measurement
#tseries_smc_filled=na.locf(tseries_plot,fromLast=F,maxgap=10)

dygraphs::dygraph(tseries_plot,width=600,height=400) %>%
  dyAxis("y",label="Relative extractable water (REW)",valueRange=c(0,2)) %>%
  dyAxis("y2",label="Net rainfall & snow melt (mixed forest) [mm]",valueRange=c(50,0)) %>%
  dyGroup(c("Oak","Pine","Mixed"),drawPoints=F,color=cols_treesp,axis="y") %>%
  dyLimit(0.2,strokePattern="dashed",color="red") %>%
  dyLimit(0.4,strokePattern="dashed",color="orange") %>%
  dyLimit(1,strokePattern="dashed",color="green") %>%
  dyOptions(stackedGraph=F,colors=cols) %>%
  dyBarSeries('prec',label="Net rainfall [mm/d]",axis="y2") %>% 
  dyBarSeries('smlt',label="Snow melt [mm/d]",axis="y2") %>%
  dyRangeSelector(height=20) %>%
  dyLegend(show="always",width=120)

```


***
### T_def per DOY
Values <Q01 are shown as point markers

```{r tdef,echo=F,warning=F,error=F,out.width="80%",fig.width=10,fig.height=13}

##plot all years
par(mfrow=c(6,1),mar=c(2,4,3,1),pty="m")
#year_plot=unique(output_oak$yr)[1]
for (year_plot in unique(output_oak$yr)){
  oak_sub=output_oak[output_oak$yr==year_plot,]
  pine_sub=output_pine[output_pine$yr==year_plot,]
  mixed_sub=mixed[mixed$yr==year_plot,]
  
  plot(NA,NA,xlim=c(1,366),ylim=c(0,8),xlab="",ylab="Transpiration deficit [mm]",main=sprintf("Transpiration deficit %i",year_plot))
  lines(oak_sub$doy,oak_sub$tdef,col=col_oak)
  lines(pine_sub$doy,pine_sub$tdef,col=col_pine)
  lines(mixed_sub$doy,mixed_sub$tdef,col=col_mixed)

  points(oak_sub$doy[oak_sub$tdef<quantile(na.omit(oak_sub$tdef),0.01)],
         oak_sub$tdef[oak_sub$tdef<quantile(na.omit(oak_sub$tdef),0.01)],col=col_oak,pch=1)
  points(pine_sub$doy[pine_sub$tdef<quantile(na.omit(pine_sub$tdef),0.01)],
         pine_sub$tdef[pine_sub$tdef<quantile(na.omit(pine_sub$tdef),0.01)],col=col_pine,pch=3)
  points(mixed_sub$doy[mixed_sub$tdef<quantile(na.omit(mixed_sub$tdef),0.01)],
         mixed_sub$tdef[mixed_sub$tdef<quantile(na.omit(mixed_sub$tdef),0.01)],col=col_mixed,pch=5)
  
  ##plot thresholds
  abline(h=0.25,col="red",lty=2)
  abline(h=0.75,col="orange",lty=2)
  
  legend("bottomright",legend=c("Oak","Pine","Mixed"),lwd=2,pch=c(1,3,5),col=cols_treesp)
  
}


##dygraph
##rfal and smlt from model results
Oak=xts(output_oak$tdef[output_oak$yr%in%unique(output_oak$yr)],order.by=output_oak$date[output_oak$yr%in%unique(output_oak$yr)])
Pine=xts(output_pine$tdef[output_pine$yr%in%unique(output_oak$yr)],order.by=output_pine$date[output_pine$yr%in%unique(output_oak$yr)])
Mixed=xts(mixed$tdef[mixed$yr%in%unique(output_oak$yr)],order.by=mixed$date[mixed$yr%in%unique(output_oak$yr)])

tseries_plot=merge(prec,smlt,Oak,Pine,Mixed)

##fill missing 15min measurements with closest measurement
#tseries_smc_filled=na.locf(tseries_plot,fromLast=F,maxgap=10)

##plot
dygraphs::dygraph(tseries_plot,width=600,height=400) %>%
  dyAxis("y",label="Transpiration deficit [mm]",valueRange=c(0,10)) %>%
  dyAxis("y2",label="Net rainfall & snow melt (mixed forest) [mm]",valueRange=c(50,0)) %>%
  dyGroup(c("Oak","Pine","Mixed"),drawPoints=F,color=cols_treesp,axis="y") %>%
  dyLimit(0.25,strokePattern="dashed",color="red") %>%
  dyLimit(0.75,strokePattern="dashed",color="orange") %>%
  dyOptions(stackedGraph=F,colors=cols) %>%
  dyBarSeries('prec',label="Net rainfall [mm/d]",axis="y2") %>% 
  dyBarSeries('smlt',label="Snow melt [mm/d]",axis="y2") %>%
  dyRangeSelector(height=20) %>%
  dyLegend(show="always",width=120)

```


***
### T_ratio per DOY
Values <Q01 are shown as point markers

```{r tratio,echo=F,warning=F,error=F,out.width="80%",fig.width=10,fig.height=13}

##plot all years
par(mfrow=c(6,1),mar=c(2,4,3,1),pty="m")
#year_plot=unique(output_oak$yr)[1]
for (year_plot in unique(output_oak$yr)){
  oak_sub=output_oak[output_oak$yr==year_plot,]
  pine_sub=output_pine[output_pine$yr==year_plot,]
  mixed_sub=mixed[mixed$yr==year_plot,]
  
  plot(NA,NA,xlim=c(1,366),ylim=c(0,1),xlab="",ylab="Transpiration ratio",main=sprintf("Transpiration ratio %i",year_plot))
  lines(oak_sub$doy,oak_sub$tratio,col=col_oak)
  lines(pine_sub$doy,pine_sub$tratio,col=col_pine)
  lines(mixed_sub$doy,mixed_sub$tratio,col=col_mixed)

  points(oak_sub$doy[oak_sub$tratio<quantile(na.omit(oak_sub$tratio),0.01)],
         oak_sub$tratio[oak_sub$tratio<quantile(na.omit(oak_sub$tratio),0.01)],col=col_oak,pch=1)
  points(pine_sub$doy[pine_sub$tratio<quantile(na.omit(pine_sub$tratio),0.01)],
         pine_sub$tratio[pine_sub$tratio<quantile(na.omit(pine_sub$tratio),0.01)],col=col_pine,pch=3)
  points(mixed_sub$doy[mixed_sub$tratio<quantile(na.omit(mixed_sub$tratio),0.01)],
         mixed_sub$tratio[mixed_sub$tratio<quantile(na.omit(mixed_sub$tratio),0.01)],col=col_mixed,pch=5)
  
  ##plot thresholds
  abline(h=0.25,col="red",lty=2)
  abline(h=0.75,col="orange",lty=2)
  
  legend("bottomright",legend=c("Oak","Pine","Mixed"),lwd=2,pch=c(1,3,5),col=cols_treesp)
  
}


##dygraph
##rfal and smlt from model results
Oak=xts(output_oak$tratio[output_oak$yr%in%unique(output_oak$yr)],order.by=output_oak$date[output_oak$yr%in%unique(output_oak$yr)])
Pine=xts(output_pine$tratio[output_pine$yr%in%unique(output_oak$yr)],order.by=output_pine$date[output_pine$yr%in%unique(output_oak$yr)])
Mixed=xts(mixed$tratio[mixed$yr%in%unique(output_oak$yr)],order.by=mixed$date[mixed$yr%in%unique(output_oak$yr)])

tseries_plot=merge(prec,smlt,Oak,Pine,Mixed)

##fill missing 15min measurements with closest measurement
#tseries_smc_filled=na.locf(tseries_plot,fromLast=F,maxgap=10)

##plot
cols=c("#0800ff","#44bbff",cols_treesp)
par(mar=c(5,5,5,5))
dygraphs::dygraph(tseries_plot,width=600,height=400) %>%
  dyAxis("y",label="Transpiration ratio",valueRange=c(0,1)) %>%
  dyAxis("y2",label="Net rainfall & snow melt (mixed forest) [mm]",valueRange=c(50,0)) %>%
  dyGroup(c("Oak","Pine","Mixed"),drawPoints=F,color=cols_treesp,axis="y") %>%
  dyLimit(0.25,strokePattern="dashed",color="red") %>%
  dyLimit(0.75,strokePattern="dashed",color="orange") %>%
  dyOptions(stackedGraph=F,colors=cols) %>%
  dyBarSeries('prec',label="Net rainfall [mm/d]",axis="y2") %>% 
  dyBarSeries('smlt',label="Snow melt [mm/d]",axis="y2") %>%
  dyRangeSelector(height=20) %>%
  dyLegend(show="always",width=120)

```


***
### Comparison of drought indicators

```{r comp,echo=F,warning=F,error=F}

par(mfrow=c(3,1),mar=c(4,4,1,1),xaxs="i",yaxs="i")
xticks=seq(as.Date("2019-01-01"),as.Date("2025-01-01"),by="year")

plot(NA,NA,xlim=c(as.Date("2019-01-01"),as.Date("2025-01-01")),ylim=c(0,1.5),xlab="",ylab="Relative extractable water",main="Relative extractable water",axes=F)
axis(side=1,at=xticks,labels=format(xticks,format="%Y"))
axis(side=2,las=1)
polygon(x=c(as.Date("2019-01-01"),as.Date("2025-01-01"),as.Date("2025-01-01"),as.Date("2019-01-01"),as.Date("2019-01-01")),
        y=c(0,0,0.2,0.2,0),border=NA,col="#ff000040")
polygon(x=c(as.Date("2019-01-01"),as.Date("2025-01-01"),as.Date("2025-01-01"),as.Date("2019-01-01"),as.Date("2019-01-01")),
        y=c(0.2,0.2,0.4,0.4,0.2),border=NA,col="#ffb20050")
polygon(x=c(as.Date("2019-01-01"),as.Date("2025-01-01"),as.Date("2025-01-01"),as.Date("2019-01-01"),as.Date("2019-01-01")),
        y=c(0.4,0.4,1.0,1.0,0.4),border=NA,col="#00aa0040")
polygon(x=c(as.Date("2019-01-01"),as.Date("2025-01-01"),as.Date("2025-01-01"),as.Date("2019-01-01"),as.Date("2019-01-01")),
        y=c(1.0,1.0,1.4,1.4,1.0),border=NA,col="#0000aa40")
lines(output_oak$date,output_oak$relawat,col=col_oak)
lines(output_pine$date,output_pine$relawat,col=col_pine)
lines(mixed$date,mixed$relawat,col=col_mixed)

plot(NA,NA,xlim=c(as.Date("2019-01-01"),as.Date("2025-01-01")),ylim=c(0,8),xlab="",ylab="Transpiration deficit [mm]",main="Transpiration deficit",axes=F)
axis(side=1,at=xticks,labels=format(xticks,format="%Y"))
axis(side=2,las=1)
lines(output_oak$date,output_oak$tdef,col=col_oak)
lines(output_pine$date,output_pine$tdef,col=col_pine)
lines(mixed_sub$doy,mixed_sub$tdef,col=col_mixed)

plot(NA,NA,xlim=c(as.Date("2019-01-01"),as.Date("2025-01-01")),ylim=c(0,1),xlab="",ylab="Transpiration ratio",main="Transpiration ratio",axes=F)
axis(side=1,at=xticks,labels=format(xticks,format="%Y"))
axis(side=2,las=1)
lines(output_oak$date,output_oak$tratio,col=col_oak)
lines(output_pine$date,output_pine$tratio,col=col_pine)
lines(mixed_sub$doy,mixed_sub$tratio,col=col_mixed)
legend("bottomright",legend=c("Oak","Pine","Mixed"),lwd=2,col=cols_treesp)

```


***
### Water balance: Mean monthly conditions

```{r annual,echo=F,message=F,warning=F,error=F}

##compute monthly sums and means
##"tdiff","evap","tran", "ievp", "gevp","surfrunoff","vrfln", "flow"
mean_list=c("snow","swat","gwat","seep","gwfl","srfl","slfl","byfl","dsfl",
                  "stres","adef","awat","relawat","nits","balerr","slrad","solnet","lngnet","aa","asubs")

sum_list=c("rfal","rint","sfal","sint","rthr","sthr","rsno","rnet",
           "smlt","intr","ints","evap","tran",
           "irvp","isvp","slvp","snvp",
           "pint","ptran","pslvp","safrac",
           "surfrunoff","flow","vrfln"
           )

##aggregate values to sum and mean
agg_sum=aggregate(wb[,..sum_list],by=list(sprintf("%i-%0.2i-01",wb$yr,wb$mo),
                                               wb$vegetation),FUN="sum")
agg_sum["date"]=as.Date(agg_sum[,1],format="%Y-%m-%d")
agg_sum["yr"]=year(agg_sum$date)
agg_sum["mo"]=month(agg_sum$date)
agg_sum["vegetation"]=agg_sum[,2]
agg_sum=agg_sum[!grepl(pattern="Group",names(agg_sum))]

agg_mean=aggregate(wb[,..mean_list],by=list(sprintf("%i-%0.2i-01",wb$yr,wb$mo),
                                                 wb$vegetation),FUN="mean")
agg_mean=agg_mean[!grepl(pattern="Group",names(agg_mean))]

##bind monthly aggregated values
evapmon=data.table(cbind(agg_sum,agg_mean))

##aggregate all variables to monthly values
evap_m=evapmon[yr %in% year(start_date):year(end_date),lapply(.SD, mean),by=list(vegetation,mo)]

##melt
hgts=melt(evap_m[,list(vegetation,mo,
                       evap=evap,
                       gevp=slvp+snvp,
                       ievp=irvp+isvp,
                       tran,
                       tdiff=ptran-tran,
                       vrfln=-vrfln,
                       surfrunoff=-surfrunoff,
                       flow=-flow)],
          id.vars=c("vegetation","mo"))


hgts$month=factor(month.abb[hgts$mo],levels=month.abb)
hgts$variable=factor(hgts$variable,levels=c("tdiff","evap","tran", "ievp", "gevp","surfrunoff","vrfln","flow"))

##precipitation
prec=meteo_daily[year(dates) %in% year(start_date):year(end_date),list(prec=sum(prec)),
           by=list(year(dates),month(dates))][,lapply(.SD,mean),by=month]
prec$month=factor(month.abb[prec$month],levels=month.abb)


##bar colors
barcolors=c("#d01c8b","#abdda4","#ffffbf","#fdae61","#91bfdb","#2b83EE","#2b83cf","#2b83ba")

##theme for plotting
theme_budg=theme(
  axis.text.x=element_text(angle=90,vjust=0.5),
  axis.line=element_line(linewidth=0.3),
  axis.ticks=element_line(linewidth=0.3),
  legend.position="right",
  legend.background=element_blank(),
  legend.key=element_blank(),
  panel.background=element_rect(color="black",fill=NA),
  panel.grid=element_blank(),
  panel.border=element_rect(colour="black",fill=NA,linewidth=0.3),
  strip.background.x=element_rect(color="black",fill=NA,linewidth=0.3),
  axis.text=element_text(size=7),
  axis.title=element_text(size=10),
  legend.text=element_text(size=8),
  legend.key.size=unit(5,"mm"))

p_budg=ggplot(hgts[!variable %in% c("evap","flow"),]) +
  geom_bar(aes(x=month,y=value,fill=variable),
           stat='identity',position='stack',color="black",linewidth=0.05) +
  geom_line(data=prec,
            aes(x=month,y=prec,group=1,color="P"),linewidth=0.4) +
  scale_color_manual(values="black",labels="P",name="") +
  scale_fill_manual(values=barcolors,labels=expression(T[D],T[a],E[i],E[s],R,D)) +
  facet_grid(~ vegetation) +
  labs(x ="Month",y="Water flux [mm]",fill="",title=NULL) +
  scale_y_continuous(sec.axis=sec_axis(transform=~.*1),breaks=seq(-100,200,50))+
  theme_budg
print(p_budg)

```


***
### Write results

```{r write,echo=F,warning=F,error=F}

write.table(output_oak[,c("date","tratio","tdef","relawat")],paste(model_path,sprintf("wb_indices_%s_oak.csv",pid),sep="/"),sep=";",quote=F,row.names=F)
write.table(output_pine[,c("date","tratio","tdef","relawat")],paste(model_path,sprintf("wb_indices_%s_pine.csv",pid),sep="/"),sep=";",quote=F,row.names=F)

```


***
### Next steps: Improve model parameterization and identify sensitive model parameters

* Meteorological data: check suitability of ERA5 reanalysis data for local SVAT modelling
* Soil data: check suitability of soil grids data sets for SVAT modelling in an Alpine environment


